{
  "tasks": [
    {
      "id": "3d2c2e5d-c74b-4e1b-9cfb-6075e5164a31",
      "name": "增强 IntersectionObserver 测试可见性控制 (setup)",
      "description": "在 src/test/setup.ts 中为 IntersectionObserver Mock 增强可控触发能力：导出 triggerVisible(el)/triggerAll() 辅助函数；默认策略可配置（全部可见或按选择器）以适配 Idle/客户端小岛在 jsdom 下的渲染时机。确保 PerformanceObserver 与 ResizeObserver 现有 Mock 不受影响。",
      "status": "completed",
      "dependencies": [],
      "createdAt": "2025-11-09T06:52:39.788Z",
      "updatedAt": "2025-11-09T07:04:00.000Z",
      "relatedFiles": [
        {
          "path": "src/test/setup.ts",
          "type": "TO_MODIFY",
          "description": "增强 IntersectionObserver Mock 并导出触发可见的辅助函数"
        }
      ],
      "implementationGuide": "pseudocode:\n- extend globalThis.IntersectionObserver mock:\n  class IO { constructor(cb, options) { this.cb = cb; } observe(el){ registry.push(el); } }\n- export function triggerVisible(el){ cb([{ target: el, isIntersecting: true }], ioInstance) }\n- export function triggerAll(){ for each observed el -> triggerVisible(el) }\n- default autoVisible=true in tests to simplify header/footer cases",
      "verificationCriteria": "在使用 Idle/IntersectionObserver 的组件测试中，调用 triggerAll() 后，延迟加载的子树应可被查询到（getByRole/getByTestId）。",
      "analysisResult": "测试修复围绕三个关键点：1) Idle/IntersectionObserver 在 jsdom 下的显式可见触发；2) 客户端小岛在测试内的 i18n 上下文注入与渲染时机控制；3) 测试查询从脆弱 testid 转向语义选择器。生产逻辑保持不变，仅在必要处为测试稳定性补充数据属性。"
    },
    {
      "id": "cbfac057-1d74-4672-96a7-6cd8fdfb5086",
      "name": "提供测试渲染助手：renderWithI18nAndLocale",
      "description": "新增测试级渲染 helper，封装 NextIntlClientProvider/ClientI18nProvider 注入 locale 与最小 messages fixture，便于渲染 Header/Footer 并稳定 i18n 钩子。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "3d2c2e5d-c74b-4e1b-9cfb-6075e5164a31"
        }
      ],
      "createdAt": "2025-11-09T06:52:39.788Z",
      "updatedAt": "2025-11-09T07:04:00.000Z",
      "relatedFiles": [
        {
          "path": "src/test/render-with-i18n.tsx",
          "type": "CREATE",
          "description": "测试渲染助手，统一注入 i18n 上下文"
        },
        {
          "path": "src/test/fixtures/messages.min.json",
          "type": "CREATE",
          "description": "最小 i18n 消息 fixture（仅含 header/footer 必需命名空间）"
        }
      ],
      "implementationGuide": "pseudocode:\n- create src/test/render-with-i18n.tsx\n- export function renderWithI18nAndLocale(ui, { locale='en', messages=fixture }) { return render(<NextIntlClientProvider locale={locale} messages={messages}>{ui}</NextIntlClientProvider>) }\n- 提供最小 messages fixture 覆盖 header/footer 所需命名空间",
      "verificationCriteria": "使用该 helper 渲染 Header/Footer 后，无 i18n 报错，能查询到期望的文本或 testid。",
      "analysisResult": "测试修复围绕三个关键点：1) Idle/IntersectionObserver 在 jsdom 下的显式可见触发；2) 客户端小岛在测试内的 i18n 上下文注入与渲染时机控制；3) 测试查询从脆弱 testid 转向语义选择器。生产逻辑保持不变，仅在必要处为测试稳定性补充数据属性。"
    },
    {
      "id": "473ecd2f-845a-4e5b-8166-cf7e8351f158",
      "name": "修复 Header 集成测试：适配 Idle/小岛与 i18n",
      "description": "更新 header 集成测试：使用 renderWithI18nAndLocale 渲染 Header（传入 locale），在断言前调用 triggerAll() 令 Idle 子树可见；优先使用语义化查询（byRole/byText），若现有用例强依赖 data-testid=\"nav-switcher\"，则最小化在小岛根容器补充 testid；清理未使用导入与参数。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "cbfac057-1d74-4672-96a7-6cd8fdfb5086"
        }
      ],
      "createdAt": "2025-11-09T06:52:39.788Z",
      "updatedAt": "2025-11-09T07:04:00.000Z",
      "relatedFiles": [
        {
          "path": "tests/integration/components/header.test.tsx",
          "type": "TO_MODIFY",
          "description": "适配 Idle 与 i18n 渲染顺序，稳定断言方式"
        },
        {
          "path": "src/components/layout/header-client.tsx",
          "type": "TO_MODIFY",
          "description": "仅当必须时，补充最小 data-testid 到 NavSwitcher 根容器"
        }
      ],
      "implementationGuide": "pseudocode:\n- import { renderWithI18nAndLocale } from '@/test/render-with-i18n'\n- const { getByRole } = renderWithI18nAndLocale(<Header locale='en' />)\n- await act(async ()=> triggerAll())\n- expect(getByRole('navigation',{name:/main/i})).toBeInTheDocument()\n- 如确需：expect(getByTestId('nav-switcher')).toBeInTheDocument()",
      "verificationCriteria": "header 测试所有用例通过，且不再出现无法找到 nav-switcher 的错误；lint 通过。",
      "analysisResult": "测试修复围绕三个关键点：1) Idle/IntersectionObserver 在 jsdom 下的显式可见触发；2) 客户端小岛在测试内的 i18n 上下文注入与渲染时机控制；3) 测试查询从脆弱 testid 转向语义选择器。生产逻辑保持不变，仅在必要处为测试稳定性补充数据属性。"
    },
    {
      "id": "893b131f-7d59-475e-8117-ae97bf13d03c",
      "name": "修复 Footer 集成测试：稳健查询与 i18n mock",
      "description": "更新 footer 集成测试：使用渲染 helper 或保持 next-intl/server 的 mock；改用 byRole/byText 等语义查询；移除未使用导入 fireEvent/waitFor 与未用形参。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "cbfac057-1d74-4672-96a7-6cd8fdfb5086"
        }
      ],
      "createdAt": "2025-11-09T06:52:39.788Z",
      "updatedAt": "2025-11-09T07:04:00.000Z",
      "relatedFiles": [
        {
          "path": "tests/integration/components/footer.test.tsx",
          "type": "TO_MODIFY",
          "description": "改用更稳健的查询并清理未使用导入/参数"
        }
      ],
      "implementationGuide": "pseudocode:\n- const { getByText, getAllByRole } = renderWithI18nAndLocale(<Footer />)\n- expect(getByText(/Tucsenberg/i)).toBeInTheDocument()\n- expect(getAllByRole('link').length).toBeGreaterThan(0)",
      "verificationCriteria": "footer 测试所有用例通过；lint 通过。",
      "analysisResult": "测试修复围绕三个关键点：1) Idle/IntersectionObserver 在 jsdom 下的显式可见触发；2) 客户端小岛在测试内的 i18n 上下文注入与渲染时机控制；3) 测试查询从脆弱 testid 转向语义选择器。生产逻辑保持不变，仅在必要处为测试稳定性补充数据属性。"
    },
    {
      "id": "ae129e39-1023-4f72-9444-8dec301f75d7",
      "name": "文档完善：Idle/动态小岛测试指南",
      "description": "在 docs/testing-standards.md 新增章节，说明 Idle/IntersectionObserver 在测试中的处理方式、如何触发可见、以及 i18n 小岛在测试中的渲染辅助方法与示例。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "3d2c2e5d-c74b-4e1b-9cfb-6075e5164a31"
        },
        {
          "taskId": "cbfac057-1d74-4672-96a7-6cd8fdfb5086"
        }
      ],
      "createdAt": "2025-11-09T06:52:39.788Z",
      "updatedAt": "2025-11-09T07:04:00.000Z",
      "relatedFiles": [
        {
          "path": "docs/testing-standards.md",
          "type": "TO_MODIFY",
          "description": "新增 Idle/小岛测试实践章节"
        }
      ],
      "implementationGuide": "pseudocode:\n- Add section 'Testing Idle & Client Islands'\n- 示例：调用 triggerAll() 让小岛渲染，再进行断言；如何使用 renderWithI18nAndLocale 包裹组件。",
      "verificationCriteria": "文档包含清晰步骤与代码片段，遵循项目书写风格，便于后续审阅。",
      "analysisResult": "测试修复围绕三个关键点：1) Idle/IntersectionObserver 在 jsdom 下的显式可见触发；2) 客户端小岛在测试内的 i18n 上下文注入与渲染时机控制；3) 测试查询从脆弱 testid 转向语义选择器。生产逻辑保持不变，仅在必要处为测试稳定性补充数据属性。"
    }
  ]
}
