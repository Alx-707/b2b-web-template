{
  "tasks": [
    {
      "id": "c3f269df-ab01-44f4-8063-2029e2bd724c",
      "name": "覆盖率基线与优先级确认",
      "description": "读取 reports/coverage/coverage-summary.json 与测试配置，形成当前覆盖率基线，列出覆盖率最低的前10个模块，并确定短期覆盖率目标≥55%。",
      "status": "pending",
      "dependencies": [],
      "createdAt": "2025-11-21T09:19:40.094Z",
      "updatedAt": "2025-11-21T09:19:40.094Z",
      "relatedFiles": [
        {
          "path": "reports/coverage/coverage-summary.json",
          "type": "REFERENCE",
          "description": "最新覆盖率摘要"
        },
        {
          "path": "vitest.config.mts",
          "type": "REFERENCE",
          "description": "覆盖率阈值与排除项"
        }
      ],
      "implementationGuide": "分析 coverage-summary.json，统计低覆盖模块（安全/监控/服务），输出文件路径+lines/functions/branches 覆盖率表格，存档到 evidence/ 或任务输出，不改代码。",
      "verificationCriteria": "生成基线报告，含Top-N低覆盖模块与短期目标(≥55%)，已存档或输出。",
      "analysisResult": "全局覆盖率约34.7%（lines），Cache Components PoC 未启用且 next-intl 兼容性阻滞，短期计划不依赖 PoC。设定短期目标：全局 lines/functions 覆盖率提升至≥55%，优先纯逻辑/安全/服务层与稳定 UI 组件。"
    },
    {
      "id": "d6758c9f-e4b3-48dc-a3a9-677463916b70",
      "name": "安全与输入验证模块测试补齐",
      "description": "为安全/输入验证模块补单测，优先 security-headers/validation/rate-limit/file-upload/tokens，目标相关文件 lines/functions 覆盖率≥60%。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "c3f269df-ab01-44f4-8063-2029e2bd724c"
        }
      ],
      "createdAt": "2025-11-21T09:19:40.094Z",
      "updatedAt": "2025-11-21T09:19:40.094Z",
      "relatedFiles": [
        {
          "path": "src/lib/security-headers.ts",
          "type": "TO_MODIFY",
          "description": "安全头工具"
        },
        {
          "path": "src/lib/security-validation.ts",
          "type": "TO_MODIFY",
          "description": "输入校验工具"
        },
        {
          "path": "src/lib/security-rate-limit.ts",
          "type": "TO_MODIFY",
          "description": "速率限制"
        },
        {
          "path": "src/lib/security-file-upload.ts",
          "type": "TO_MODIFY",
          "description": "文件上传校验"
        },
        {
          "path": "src/lib/security-tokens.ts",
          "type": "TO_MODIFY",
          "description": "令牌生成与验证"
        },
        {
          "path": "tests/unit/security",
          "type": "CREATE",
          "description": "新增安全模块测试目录"
        }
      ],
      "implementationGuide": "编写 Vitest 单测覆盖正常/异常/边界输入；rate limit 用 fake timers；禁止真实网络；必要时微调代码以便注入依赖但保持 API 兼容。",
      "verificationCriteria": "相关模块 lines/functions 覆盖率≥60%，包含非法输入/边界用例，测试使用 Vitest。",
      "analysisResult": "全局覆盖率约34.7%（lines），Cache Components PoC 未启用且 next-intl 兼容性阻滞，短期计划不依赖 PoC。设定短期目标：全局 lines/functions 覆盖率提升至≥55%，优先纯逻辑/安全/服务层与稳定 UI 组件。"
    },
    {
      "id": "6db8d1ed-65e4-4bd9-b341-acd6300e3ba0",
      "name": "API 边界与输入校验测试",
      "description": "为 contact/web-vitals/whatsapp/subscribe/health 等 API 路由补集成/契约测试，覆盖成功与失败路径，目标各路由文件 lines/functions ≥50%。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "c3f269df-ab01-44f4-8063-2029e2bd724c"
        }
      ],
      "createdAt": "2025-11-21T09:19:40.094Z",
      "updatedAt": "2025-11-21T09:19:40.094Z",
      "relatedFiles": [
        {
          "path": "src/app/api/contact/route.ts",
          "type": "TO_MODIFY",
          "description": "联系表单 API"
        },
        {
          "path": "src/app/api/verify-turnstile/route.ts",
          "type": "TO_MODIFY",
          "description": "Turnstile 验证"
        },
        {
          "path": "src/app/api/analytics/web-vitals/route.ts",
          "type": "TO_MODIFY",
          "description": "Web Vitals ingestion"
        },
        {
          "path": "src/app/api/whatsapp/send/route.ts",
          "type": "TO_MODIFY",
          "description": "WhatsApp 发送"
        },
        {
          "path": "src/app/api/whatsapp/webhook/route.ts",
          "type": "TO_MODIFY",
          "description": "WhatsApp Webhook"
        },
        {
          "path": "src/app/api/subscribe/route.ts",
          "type": "TO_MODIFY",
          "description": "订阅 API"
        },
        {
          "path": "src/app/api/health/route.ts",
          "type": "TO_MODIFY",
          "description": "健康检查"
        },
        {
          "path": "tests/integration/api",
          "type": "CREATE",
          "description": "新增 API 集成测试"
        }
      ],
      "implementationGuide": "用 Vitest 调用 handler 或 supertest；mock Resend/Airtable/Turnstile 等外部依赖；覆盖 4xx/5xx/成功路径，并检查基本头部/状态码。",
      "verificationCriteria": "每个目标路由覆盖成功+错误输入+异常路径；无真实外部网络；相关文件 lines/functions ≥50%。",
      "analysisResult": "全局覆盖率约34.7%（lines），Cache Components PoC 未启用且 next-intl 兼容性阻滞，短期计划不依赖 PoC。设定短期目标：全局 lines/functions 覆盖率提升至≥55%，优先纯逻辑/安全/服务层与稳定 UI 组件。"
    },
    {
      "id": "d0b3b23f-4a7e-48e1-a386-40178863a34f",
      "name": "业务服务与缓存工具测试",
      "description": "提升服务层与缓存/存储工具覆盖率（content-parser、content-validation、cache-utils、locale-storage、i18n cache），目标相关文件 lines/functions ≥55%。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "c3f269df-ab01-44f4-8063-2029e2bd724c"
        }
      ],
      "createdAt": "2025-11-21T09:19:40.094Z",
      "updatedAt": "2025-11-21T09:19:40.094Z",
      "relatedFiles": [
        {
          "path": "src/lib/content-parser.ts",
          "type": "TO_MODIFY",
          "description": "内容解析"
        },
        {
          "path": "src/lib/content-validation.ts",
          "type": "TO_MODIFY",
          "description": "内容校验"
        },
        {
          "path": "src/lib/cache-utils.ts",
          "type": "TO_MODIFY",
          "description": "缓存工具"
        },
        {
          "path": "src/lib/locale-storage-*",
          "type": "TO_MODIFY",
          "description": "本地存储/历史"
        },
        {
          "path": "src/lib/i18n-cache.ts",
          "type": "TO_MODIFY",
          "description": "i18n 缓存"
        },
        {
          "path": "tests/unit/cache",
          "type": "CREATE",
          "description": "新增缓存相关测试"
        }
      ],
      "implementationGuide": "为纯函数/缓存逻辑写单测，使用 fake timers/内存 stub；验证命中/失效/异常路径；如需拆小函数以便测试，保持对外接口不变。",
      "verificationCriteria": "目标文件 lines/functions ≥55%，覆盖命中/失效/异常路径，测试可重复且无外部 IO。",
      "analysisResult": "全局覆盖率约34.7%（lines），Cache Components PoC 未启用且 next-intl 兼容性阻滞，短期计划不依赖 PoC。设定短期目标：全局 lines/functions 覆盖率提升至≥55%，优先纯逻辑/安全/服务层与稳定 UI 组件。"
    },
    {
      "id": "a0708c22-dcf0-465e-b0c4-8ca85de8dc3e",
      "name": "核心交互与表单组件测试",
      "description": "为稳定的 UI 组件（Header/Footer/语言切换/联系表单等）补交互与可访问性测试，目标组件 lines/functions ≥60%。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "c3f269df-ab01-44f4-8063-2029e2bd724c"
        }
      ],
      "createdAt": "2025-11-21T09:19:40.094Z",
      "updatedAt": "2025-11-21T09:19:40.094Z",
      "relatedFiles": [
        {
          "path": "src/components/layout/header.tsx",
          "type": "TO_MODIFY",
          "description": "头部"
        },
        {
          "path": "src/components/layout/footer.tsx",
          "type": "TO_MODIFY",
          "description": "底部"
        },
        {
          "path": "src/components/language-toggle.tsx",
          "type": "TO_MODIFY",
          "description": "语言切换"
        },
        {
          "path": "src/components/forms/contact-form*.tsx",
          "type": "TO_MODIFY",
          "description": "联系表单相关"
        },
        {
          "path": "tests/unit/components",
          "type": "CREATE",
          "description": "新增组件测试"
        }
      ],
      "implementationGuide": "Testing Library + jsdom，覆盖渲染、主要交互、必备 aria；表单含错误/成功提示；避免依赖未来 Cache Components 行为，聚焦现有 UI。",
      "verificationCriteria": "目标组件 lines/functions ≥60%；交互含键盘/aria；无 Cache Components 依赖。",
      "analysisResult": "全局覆盖率约34.7%（lines），Cache Components PoC 未启用且 next-intl 兼容性阻滞，短期计划不依赖 PoC。设定短期目标：全局 lines/functions 覆盖率提升至≥55%，优先纯逻辑/安全/服务层与稳定 UI 组件。"
    },
    {
      "id": "436deca8-d538-40f1-8144-b550ba932851",
      "name": "报告与阈值调优",
      "description": "聚合新增测试后更新覆盖率报告，若个别文件超高阈值阻断，可在不降低总体目标下微调阈值或拆分文件。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "d6758c9f-e4b3-48dc-a3a9-677463916b70"
        },
        {
          "taskId": "6db8d1ed-65e4-4bd9-b341-acd6300e3ba0"
        },
        {
          "taskId": "d0b3b23f-4a7e-48e1-a386-40178863a34f"
        },
        {
          "taskId": "a0708c22-dcf0-465e-b0c4-8ca85de8dc3e"
        }
      ],
      "createdAt": "2025-11-21T09:19:40.094Z",
      "updatedAt": "2025-11-21T09:19:40.094Z",
      "relatedFiles": [
        {
          "path": "vitest.config.mts",
          "type": "TO_MODIFY",
          "description": "阈值调整"
        },
        {
          "path": "reports/coverage",
          "type": "REFERENCE",
          "description": "覆盖率报告输出"
        }
      ],
      "implementationGuide": "运行 pnpm test:coverage，收集 reports/coverage；仅对不合理的阈值下调至现实可达（仍≥55%）；记录调整理由并更新配置。",
      "verificationCriteria": "全局 lines/functions 覆盖率≥55%；无不合理阈值导致的阻断；阈值调整有记录。",
      "analysisResult": "全局覆盖率约34.7%（lines），Cache Components PoC 未启用且 next-intl 兼容性阻滞，短期计划不依赖 PoC。设定短期目标：全局 lines/functions 覆盖率提升至≥55%，优先纯逻辑/安全/服务层与稳定 UI 组件。"
    }
  ]
}