{
  "tasks": [
    {
      "id": "f0c6f2b0-2a6f-4c5a-bd2e-6a5a5c4f0a01",
      "name": "T0: 失败基线重建与分组",
      "description": "解析 reports/playwright-results.json 与 test-results 附件，按项目(Chromium/Firefox/WebKit/移动)与 spec 聚类失败；标注 flake 嫌疑（Portal/动画/移动视图导致的瞬时不可见）与真正断言/兼容性问题。产出新的失败矩阵作为后续任务输入。",
      "status": "completed",
      "dependencies": [],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:01:30.696Z",
      "relatedFiles": [
        {
          "path": "reports/playwright-results.json",
          "type": "REFERENCE",
          "description": "失败明细来源"
        },
        {
          "path": "test-results/",
          "type": "REFERENCE",
          "description": "截图/视频/错误上下文"
        },
        {
          "path": "reports/e2e-failure-matrix.md",
          "type": "OUTPUT",
          "description": "失败聚合矩阵"
        },
        {
          "path": "reports/e2e-failure-matrix.json",
          "type": "OUTPUT",
          "description": "失败矩阵（JSON）"
        }
      ],
      "implementationGuide": "使用 Node 脚本或一次性命令聚合各项目失败条目与首行报错，输出CSV/Markdown矩阵；按‘可见性/等待/路径/兼容性/a11y/脚本错误’分类标注。",
      "verificationCriteria": "生成的失败矩阵覆盖全部失败条目且分类明确；后续任务能直接引用定位到具体文件与断言。",
      "analysisResult": "当前主要簇：下拉显隐(Portal/动画)、html[lang] 等待、a11y 二次注入、移动导航断言、路径末尾斜杠、已知浏览器兼容限制。"
    },
    {
      "id": "7b3f2a9c-0f4a-4e4e-8f5c-2c7b3b9e1102",
      "name": "T1: 稳定下拉显隐断言（Radix/Portal）",
      "description": "将语言下拉与导航下拉的可见性断言从‘立即 toBeVisible’改为基于触发器 aria-expanded 或内容 data-state=open，并在必要时先验证 toBeAttached 与元素尺寸>0，减少动画/Portal 导致的抖动。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "f0c6f2b0-2a6f-4c5a-bd2e-6a5a5c4f0a01"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:01:30.698Z",
      "relatedFiles": [
        {
          "path": "tests/e2e/i18n.spec.ts",
          "type": "TO_MODIFY",
          "description": "语言切换下拉断言策略"
        },
        {
          "path": "tests/e2e/navigation.spec.ts",
          "type": "TO_MODIFY",
          "description": "导航下拉/抽屉显隐断言"
        },
        {
          "path": "tests/e2e/debug-dropdown.spec.ts",
          "type": "TO_MODIFY",
          "description": "调试下拉用例稳定化"
        }
      ],
      "implementationGuide": "触发后先断言 trigger[aria-expanded=true] 或 content[data-state=\"open\"]；必要时用 expect(locator).toBeAttached() + boundingBox()!=null；减少硬等待。",
      "verificationCriteria": "相关用例在 Desktop/Mobile/Firefox/WebKit 全部稳定通过，重跑无 flake。",
      "analysisResult": "根因是 Portal + 动画与移动指针事件差异造成短期不可见，改断言语义即可稳定。"
    },
    {
      "id": "2d8a6e74-6f3a-4d7e-8d56-0b9a7e4c3103",
      "name": "T2: 替换 html[lang] 等待方式",
      "description": "将 waitForFunction(document.documentElement.lang===…) 替换为 expect(page.locator('html')).toHaveAttribute('lang', 目标值) 或直接 waitForSelector('html[lang=…]')，并在移动端场景提供中文导航可见性兜底。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "f0c6f2b0-2a6f-4c5a-bd2e-6a5a5c4f0a01"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:01:30.700Z",
      "relatedFiles": [
        {
          "path": "tests/e2e/i18n.spec.ts",
          "type": "TO_MODIFY",
          "description": "html[lang] 断言更换为内置智能等待"
        }
      ],
      "implementationGuide": "统一改用 toHaveAttribute('lang', 'zh'|'en')；对 path 保持用例并行校验 URL 与中文关键元素。",
      "verificationCriteria": "所有与语言切换相关超时用例消除；Chromium/Firefox/WebKit/移动全绿。",
      "analysisResult": "Playwright 内置期望具备智能等待，较自定义 waitForFunction 更稳。"
    },
    {
      "id": "b1a0f7c5-0eab-4d0d-8a21-7c3dfd1a4104",
      "name": "T3: 统一 axe 规则与二次注入",
      "description": "在导航后再次 injectAxe；默认仅关注 critical/serious 级别并临时关闭易受主题/对比度影响的 color-contrast 规则（可通过环境开关切换为严格模式）。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "f0c6f2b0-2a6f-4c5a-bd2e-6a5a5c4f0a01"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:14:29.315Z",
      "relatedFiles": [
        {
          "path": "tests/e2e/i18n.spec.ts",
          "type": "TO_MODIFY",
          "description": "切换后再注入 axe 并限制impact"
        },
        {
          "path": "tests/e2e/navigation.spec.ts",
          "type": "TO_MODIFY",
          "description": "如有二次检查，同步策略"
        }
      ],
      "implementationGuide": "切换语言 + waitForStable 后执行 injectAxe，再执行 checkA11y；通过 env 变量控制是否启用 color-contrast。",
      "verificationCriteria": "a11y 相关失败归零（除非明确记录为兼容性限制），报告聚焦可行动问题。",
      "analysisResult": "导航刷新更换上下文导致 window.axe 失效，需再次注入；对比度规则在主题/平台上波动大。"
    },
    {
      "id": "9f4b3d86-1c2d-4f10-9a40-4a0a1d8e5105",
      "name": "T4: 移动端导航断言与交互修正",
      "description": "移动场景统一先点击‘Toggle mobile menu’打开 Sheet，再在 Sheet 内断言导航链接；Firefox 仅用 viewport + hasTouch（不使用 isMobile）。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "f0c6f2b0-2a6f-4c5a-bd2e-6a5a5c4f0a01"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:14:29.316Z",
      "relatedFiles": [
        {
          "path": "tests/e2e/navigation.spec.ts",
          "type": "TO_MODIFY",
          "description": "移动端断言走 Sheet 视图"
        },
        {
          "path": "tests/e2e/i18n.spec.ts",
          "type": "TO_MODIFY",
          "description": "移动用例交互使用 tap/点击兜底"
        }
      ],
      "implementationGuide": "在 mobile 场景先打开对话框，随后断言其中链接与可见性；避免直接断言桌面导航元素。",
      "verificationCriteria": "Mobile Chrome / Mobile Safari 下导航类用例 100% 通过且无波动。",
      "analysisResult": "桌面与移动渲染结构不同；直接断桌面选择器在移动下不成立。"
    },
    {
      "id": "d672e0a4-3b7e-4c98-8a82-0a7e61d05106",
      "name": "T5: 规范路径断言与末尾斜杠",
      "description": "统一 URL 断言为包含或正则尾斜杠可选（…\\/?$），覆盖 WebKit/Safari 在路径处理上的细小差异。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "f0c6f2b0-2a6f-4c5a-bd2e-6a5a5c4f0a01"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:14:29.318Z",
      "relatedFiles": [
        {
          "path": "tests/e2e/i18n-redirect-validation.spec.ts",
          "type": "TO_MODIFY",
          "description": "路径正则尾斜杠放宽"
        },
        {
          "path": "tests/e2e/i18n.spec.ts",
          "type": "TO_MODIFY",
          "description": "局部URL断言对齐"
        }
      ],
      "implementationGuide": "将 toMatch(/…$/) 改为 /…\\/?$/ 或使用 toContain('/zh/about')；保持与共享本地化路径一致。",
      "verificationCriteria": "WebKit/Safari 上的路径匹配不再失败。",
      "analysisResult": "不同引擎和重定向链可能产生末尾斜杠差异。"
    },
    {
      "id": "4a2c1b7d-8d10-49af-9a78-1c2d3e7f7107",
      "name": "T6: 标注并隔离已知兼容性限制",
      "description": "记录并在用例层面隔离已知引擎限制：Firefox 不支持 isMobile；如遇 WebKit 特有指针/焦点问题，提供条件分支或合理跳过（附注释与问题编号）。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "f0c6f2b0-2a6f-4c5a-bd2e-6a5a5c4f0a01"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:14:29.318Z",
      "relatedFiles": [
        {
          "path": "tests/e2e/i18n.spec.ts",
          "type": "TO_MODIFY",
          "description": "去除 isMobile；按需条件 skip"
        },
        {
          "path": "tests/e2e/navigation.spec.ts",
          "type": "REFERENCE",
          "description": "如需条件跳过，保持注释与理由"
        }
      ],
      "implementationGuide": "使用 test.skip(({browserName})=>…,'原因') 或条件分支；所有跳过需在文档与矩阵中登记。",
      "verificationCriteria": "除已登记兼容性BUG外，整体通过率达100%。",
      "analysisResult": "保证目标‘100%通过率（除已知BUG）’的同时，透明化兼容性边界。"
    },
    {
      "id": "f5a1c9d0-6e9a-4db0-8a3f-5b1c0a8e8108",
      "name": "T7: 处理测试结束挂起问题",
      "description": "本地执行时强制 CI=1 禁用 webServer 复用或在需要时将 reuseExistingServer 设为 false；排查可能未清理的 route/事件监听。提供运行手册与脚本示例。",
      "status": "completed",
      "dependencies": [],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:14:29.320Z",
      "relatedFiles": [
        {
          "path": "playwright.config.ts",
          "type": "REFERENCE",
          "description": "webServer.reuseExistingServer 策略说明"
        },
        {
          "path": "README.md",
          "type": "TO_MODIFY",
          "description": "补充本地执行说明（可选）"
        },
        {
          "path": "package.json",
          "type": "TO_MODIFY",
          "description": "新增 test:e2e:no-reuse 与 test:e2e:ci-local"
        }
      ],
      "implementationGuide": "建议使用 `CI=1 pnpm test:e2e` 本地复现；如仍挂起，临时关闭复用；确保自定义 page.route/事件在测试结束自动释放。",
      "verificationCriteria": "本地/CI 执行结束均无残留进程；Playwright 进程正常退出。",
      "analysisResult": "复用已存在服务器可能导致进程表现为‘卡住’，规范运行方式可避免。"
    },
    {
      "id": "a4b2e1c0-5d3f-4a7a-9b2e-6c1d2e3f9109",
      "name": "T8: 全量重跑并输出报告",
      "description": "在安装完整浏览器运行时后全量重跑 `pnpm test:e2e`，汇总通过率、失败清单、慢测TOP5，并将报告产出到 reports/ 下供审阅。",
      "status": "in_progress",
      "dependencies": [
        {
          "taskId": "7b3f2a9c-0f4a-4e4e-8f5c-2c7b3b9e1102"
        },
        {
          "taskId": "2d8a6e74-6f3a-4d7e-8d56-0b9a7e4c3103"
        },
        {
          "taskId": "b1a0f7c5-0eab-4d0d-8a21-7c3dfd1a4104"
        },
        {
          "taskId": "9f4b3d86-1c2d-4f10-9a40-4a0a1d8e5105"
        },
        {
          "taskId": "d672e0a4-3b7e-4c98-8a82-0a7e61d05106"
        },
        {
          "taskId": "4a2c1b7d-8d10-49af-9a78-1c2d3e7f7107"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-13T00:06:17.492Z",
      "relatedFiles": [
        {
          "path": "reports/",
          "type": "CREATE",
          "description": "输出最新 Playwright 报告与聚合摘要"
        },
        {
          "path": "reports/e2e-summary-latest.json",
          "type": "OUTPUT",
          "description": "E2E 汇总（JSON）"
        },
        {
          "path": "reports/e2e-summary-latest.md",
          "type": "OUTPUT",
          "description": "E2E 汇总（Markdown）"
        }
      ],
      "implementationGuide": "使用 JSON 报告生成器汇总各项目（chromium/firefox/webkit/移动）的 total/failed/passed；标注仍失败的任务与归属任务编号。",
      "verificationCriteria": "通过率达预期（除已登记兼容性BUG外 100%），并产生结构化摘要。",
      "analysisResult": "作为阶段性验收，确保前述稳定化修改真正落地。"
    },
    {
      "id": "c7d9e2f1-8a0b-4c6d-9e1f-2b3c4d5e1110",
      "name": "T9: 持续去抖与回归验证",
      "description": "对历史易抖用例增加更稳健的语义断言或轻量等待策略；在 CI 中开启无重试(retries=0)抽样跑，确保零 flake；必要时对关键用例开启 trace-on-first-retry 并周期性回归。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "a4b2e1c0-5d3f-4a7a-9b2e-6c1d2e3f9109"
        }
      ],
      "createdAt": "2025-10-12T13:45:00.000Z",
      "updatedAt": "2025-10-12T15:14:29.328Z",
      "relatedFiles": [
        {
          "path": "playwright.config.ts",
          "type": "REFERENCE",
          "description": "按需调整 retries/trace 策略（仅在CI）"
        }
      ],
      "implementationGuide": "对波动点增加‘状态断言优先于显隐’原则；定期生成 flake 报告对比；将经验沉淀到 docs/quality/ 指南。",
      "verificationCriteria": "回归跑稳定，无新增波动；flake 指标下降并稳定在0。",
      "analysisResult": "确保长期稳定与可维护性，不仅达成一次性绿灯。"
    }
  ]
}
