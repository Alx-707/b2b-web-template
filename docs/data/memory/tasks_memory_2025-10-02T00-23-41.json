{
  "tasks": [
    {
      "id": "b78db462-c27b-44c8-8ac9-f77cab00cbd4",
      "name": "任务2: 语言切换高级信息国际化修复",
      "description": "修复 EnhancedLocaleSwitcher 组件中的英文硬编码,将 Detection Info 相关文案改为使用翻译系统",
      "notes": "注意: 这个组件只在 showDetectionInfo=true 时显示,需要在测试时确保该 prop 为 true。LocaleDetectionDemo 组件使用了这个功能,可以作为测试入口。",
      "status": "completed",
      "dependencies": [],
      "createdAt": "2025-09-30T07:37:29.094Z",
      "updatedAt": "2025-09-30T07:49:06.404Z",
      "relatedFiles": [
        {
          "path": "src/components/i18n/locale-switcher/enhanced-locale-switcher-component.tsx",
          "type": "TO_MODIFY",
          "description": "增强型语言切换器组件,需要修改 Detection Info 相关硬编码",
          "lineStart": 73,
          "lineEnd": 121
        },
        {
          "path": "messages/en.json",
          "type": "TO_MODIFY",
          "description": "英文翻译文件,需要添加 language.detector 命名空间"
        },
        {
          "path": "messages/zh.json",
          "type": "TO_MODIFY",
          "description": "中文翻译文件,需要添加 language.detector 命名空间"
        },
        {
          "path": "src/components/i18n/locale-detection-demo.tsx",
          "type": "REFERENCE",
          "description": "语言检测演示组件,使用了 showDetectionInfo 功能,可作为测试参考"
        }
      ],
      "implementationGuide": "## 实现步骤\n\n### 1. 分析现有代码\n- 文件: src/components/i18n/locale-switcher/enhanced-locale-switcher-component.tsx\n- 问题行: 73, 78, 88, 99, 114, 121\n- 硬编码内容: \"Detection Info\", \"Source\", \"✓ User preference saved\"\n\n### 2. 添加翻译键\n\n**messages/en.json** 添加:\n```json\n\"language\": {\n  \"detector\": {\n    \"title\": \"Detection Info\",\n    \"source\": \"Source\",\n    \"confidence\": \"Confidence\",\n    \"userSaved\": \"✓ User preference saved\",\n    \"sources\": {\n      \"browser\": \"Browser\",\n      \"cookie\": \"Cookie\",\n      \"url\": \"URL\",\n      \"header\": \"Header\",\n      \"default\": \"Default\"\n    }\n  }\n}\n```\n\n**messages/zh.json** 添加:\n```json\n\"language\": {\n  \"detector\": {\n    \"title\": \"检测信息\",\n    \"source\": \"来源\",\n    \"confidence\": \"置信度\",\n    \"userSaved\": \"✓ 用户偏好已保存\",\n    \"sources\": {\n      \"browser\": \"浏览器\",\n      \"cookie\": \"Cookie\",\n      \"url\": \"URL\",\n      \"header\": \"请求头\",\n      \"default\": \"默认\"\n    }\n  }\n}\n```\n\n### 3. 修改组件代码\n\n在 enhanced-locale-switcher-component.tsx 中:\n\n```typescript\n// 确保已导入 useTranslations\nimport { useTranslations } from 'next-intl';\n\n// 在组件内添加\nconst t = useTranslations('language.detector');\n\n// 修改第 73 行\n<div className=\"text-xs font-semibold\">{t('title')}</div>\n\n// 修改第 78 行\n<span className=\"text-muted-foreground\">{t('source')}:</span>\n\n// 修改第 88 行 (source 值)\n<span className=\"font-medium\">{t(`sources.${source}`)}</span>\n\n// 修改第 99 行\n<span className=\"text-muted-foreground\">{t('confidence')}:</span>\n\n// 修改第 114 行\n<div className=\"text-xs text-green-600\">{t('userSaved')}</div>\n```\n\n### 4. 处理 DetectionInfoSection 子组件\n\n如果 DetectionInfoSection 是独立组件,需要:\n1. 将 `t` 函数作为 prop 传递\n2. 或在子组件内部也调用 useTranslations('language.detector')\n\n### 5. 类型定义更新\n\n如果有 TypeScript 类型定义,确保 source 类型包含所有可能值:\n```typescript\ntype DetectionSource = 'browser' | 'cookie' | 'url' | 'header' | 'default';\n```",
      "verificationCriteria": "## 验证标准\n\n### 代码质量检查\n- ✅ ESLint 0 errors, 0 warnings\n- ✅ TypeScript 0 errors\n- ✅ Prettier 格式化通过\n\n### 功能验证\n\n#### 前置条件\n找到使用 EnhancedLocaleSwitcher 且 showDetectionInfo=true 的页面,或创建测试页面:\n```typescript\n<EnhancedLocaleSwitcher showDetectionInfo={true} />\n```\n\n#### 英文页面验证 (http://localhost:3000/en)\n1. 打开语言切换器下拉菜单\n2. 检查 Detection Info 区块显示:\n   - 标题: \"Detection Info\"\n   - 来源标签: \"Source: Browser\" (或其他来源)\n   - 置信度标签: \"Confidence: 95%\" (或其他值)\n   - 用户偏好提示: \"✓ User preference saved\"\n3. 确认无任何中文内容\n\n#### 中文页面验证 (http://localhost:3000/zh)\n1. 打开语言切换器下拉菜单\n2. 检查检测信息区块显示:\n   - 标题: \"检测信息\"\n   - 来源标签: \"来源: 浏览器\" (或其他来源)\n   - 置信度标签: \"置信度: 95%\" (或其他值)\n   - 用户偏好提示: \"✓ 用户偏好已保存\"\n3. 确认无任何英文内容(除技术术语)\n\n### 边界情况测试\n- 测试所有可能的 source 值: browser, cookie, url, header, default\n- 测试不同的 confidence 值\n- 测试 isUserOverride 为 true/false 的情况\n\n### 代码检查\n```bash\n# 确认无硬编码英文\ngrep -n \"Detection Info\\|Source\\|User preference saved\" src/components/i18n/locale-switcher/enhanced-locale-switcher-component.tsx\n# 应该返回空结果或只在注释中\n```",
      "analysisResult": "## 全局分析结果\n\n### 任务目标\n修复项目中所有用户可见的硬编码问题,确保英文页面无中文、中文页面无英文(技术名称除外),实现完整的国际化支持。\n\n### 技术栈\n- Next.js 15 App Router\n- React 19\n- TypeScript 5.8\n- next-intl 4.3.4 国际化系统\n- 翻译文件: messages/en.json, messages/zh.json\n\n### 已完成\n✅ Tech Stack 数据国际化 (src/lib/tech-stack-data.ts)\n✅ Project Overview 语言单位国际化 (src/components/home/project-overview.tsx)\n\n### 待修复问题分类\n\n#### 高优先级 (用户可见)\n1. **主题切换器中英混排** - 中文页面显示 \"明亮模式 Light\"\n2. **语言切换高级信息英文硬编码** - 中文页面显示 \"Detection Info\"\n3. **无障碍播报默认语言** - 默认为中文,应跟随当前 locale\n\n#### 中优先级 (建议修复)\n4. **语言配置 region 字段** - 预防性修复,为未来 UI 展示做准备\n\n#### 低优先级 (可选)\n5. **CSS 颜色字面量** - 开发工具和邮件模板,不影响用户体验\n\n### 修复原则\n- 所有用户可见文案必须通过 next-intl 翻译系统\n- 使用 useTranslations() Hook 获取翻译\n- 翻译键统一管理在 messages/en.json 和 messages/zh.json\n- 保持代码简洁,避免重复\n- 每个任务独立可验证",
      "summary": "任务2完成: EnhancedLocaleSwitcher组件国际化修复成功。添加language.detector命名空间到en.json和zh.json,修改DetectionInfoSection组件使用useTranslations('language.detector'),所有硬编码英文(Detection Info, Source, User preference saved)已替换为翻译键,支持所有detection source类型(browser/cookie/url/header/default/user/stored/geo/timezone)。质量检查: ESLint 0错误, TypeScript 0错误, Prettier格式化通过。",
      "completedAt": "2025-09-30T07:49:06.402Z"
    },
    {
      "id": "36de06a0-301d-4f09-9900-cd0179729672",
      "name": "任务3: 无障碍播报语言跟随 locale",
      "description": "修复 accessibility-manager.ts 默认语言为中文的问题,使其跟随当前页面 locale 动态切换",
      "notes": "注意: 这个修改涉及到 Hook 的使用,需要确保 use-theme-toggle.ts 是在 React 组件上下文中调用的。如果 accessibilityManager 在非 React 上下文中使用,需要考虑其他方案(如通过事件系统传递 locale)。",
      "status": "completed",
      "dependencies": [],
      "createdAt": "2025-09-30T07:37:29.094Z",
      "updatedAt": "2025-09-30T07:49:10.233Z",
      "relatedFiles": [
        {
          "path": "src/lib/accessibility-manager.ts",
          "type": "TO_MODIFY",
          "description": "无障碍管理器,需要修改默认语言和兜底文案",
          "lineStart": 20,
          "lineEnd": 67
        },
        {
          "path": "src/hooks/use-theme-toggle.ts",
          "type": "TO_MODIFY",
          "description": "主题切换 Hook,需要添加 locale 绑定逻辑"
        },
        {
          "path": "messages/en.json",
          "type": "TO_MODIFY",
          "description": "英文翻译文件,可选添加 accessibility 命名空间"
        },
        {
          "path": "messages/zh.json",
          "type": "TO_MODIFY",
          "description": "中文翻译文件,可选添加 accessibility 命名空间"
        }
      ],
      "implementationGuide": "## 实现步骤\n\n### 1. 分析现有代码\n- 文件: src/lib/accessibility-manager.ts\n- 问题行: 20 (默认 language: 'zh')\n- 问题行: 67 (兜底中文 \"已切换到${theme}模式\")\n\n### 2. 修改 accessibility-manager.ts\n\n#### 2.1 修改默认语言\n```typescript\n// 第 20 行附近\nprivate language: string = 'en'; // 改为英文默认,或从环境变量读取\n```\n\n#### 2.2 移除硬编码中文兜底\n```typescript\n// 第 67 行附近,移除或改为英文兜底\n// 原代码: message = `已切换到${theme}模式`;\n// 改为:\nmessage = `Switched to ${theme} mode`;\n```\n\n### 3. 在主题切换 Hook 中绑定 locale\n\n文件: src/hooks/use-theme-toggle.ts\n\n```typescript\nimport { useLocale } from 'next-intl';\nimport { accessibilityManager } from '@/lib/accessibility';\nimport { useEffect } from 'react';\n\n// 在 Hook 内部添加\nconst locale = useLocale();\n\nuseEffect(() => {\n  // 将 locale 映射到语言代码\n  const language = locale === 'zh' ? 'zh' : 'en';\n  accessibilityManager.setLanguage(language);\n}, [locale]);\n```\n\n### 4. 检查其他使用 accessibilityManager 的地方\n\n搜索所有调用 accessibilityManager 的文件:\n```bash\ngrep -r \"accessibilityManager\" src/\n```\n\n确保所有使用处都能正确处理语言切换。\n\n### 5. 考虑更完善的方案\n\n如果需要更完善的无障碍播报国际化,可以:\n\n#### 5.1 创建翻译键\n\n**messages/en.json**:\n```json\n\"accessibility\": {\n  \"theme\": {\n    \"switched\": \"Switched to {theme} mode\",\n    \"light\": \"light\",\n    \"dark\": \"dark\",\n    \"system\": \"system\"\n  }\n}\n```\n\n**messages/zh.json**:\n```json\n\"accessibility\": {\n  \"theme\": {\n    \"switched\": \"已切换到{theme}模式\",\n    \"light\": \"明亮\",\n    \"dark\": \"暗黑\",\n    \"system\": \"系统\"\n  }\n}\n```\n\n#### 5.2 修改 announceThemeChange 方法\n\n在 accessibility-manager.ts 中:\n```typescript\n// 接收翻译函数作为参数\npublic announceThemeChange(\n  theme: string,\n  t?: (key: string, values?: Record<string, string>) => string\n): void {\n  if (!this.enabled) return;\n  \n  let message: string;\n  if (t) {\n    const themeLabel = t(`accessibility.theme.${theme}`);\n    message = t('accessibility.theme.switched', { theme: themeLabel });\n  } else {\n    // 英文兜底\n    message = `Switched to ${theme} mode`;\n  }\n  \n  this.announce(message);\n}\n```\n\n#### 5.3 在调用处传入翻译函数\n\n在 use-theme-toggle.ts 中:\n```typescript\nconst t = useTranslations();\n\n// 调用时传入翻译函数\naccessibilityManager.announceThemeChange(theme, t);\n```",
      "verificationCriteria": "## 验证标准\n\n### 代码质量检查\n- ✅ ESLint 0 errors, 0 warnings\n- ✅ TypeScript 0 errors\n- ✅ Prettier 格式化通过\n\n### 功能验证\n\n#### 前置条件\n需要启用屏幕阅读器或使用浏览器的无障碍工具来验证播报内容。\n\n#### 英文页面验证 (http://localhost:3000/en)\n1. 打开页面,确保屏幕阅读器运行\n2. 切换主题(Light → Dark → System)\n3. 验证播报内容:\n   - \"Switched to dark mode\"\n   - \"Switched to light mode\"\n   - \"Switched to system mode\"\n4. 确认无任何中文播报\n\n#### 中文页面验证 (http://localhost:3000/zh)\n1. 打开页面,确保屏幕阅读器运行\n2. 切换主题(明亮 → 暗黑 → 系统)\n3. 验证播报内容:\n   - \"已切换到暗黑模式\"\n   - \"已切换到明亮模式\"\n   - \"已切换到系统模式\"\n4. 确认无任何英文播报\n\n#### 语言切换测试\n1. 在英文页面切换主题,验证英文播报\n2. 切换到中文页面\n3. 再次切换主题,验证中文播报\n4. 确认语言跟随 locale 正确切换\n\n### 代码检查\n```bash\n# 确认默认语言不是中文\ngrep -n \"language.*zh\" src/lib/accessibility-manager.ts\n# 应该只在 setLanguage 方法中出现\n\n# 确认无硬编码中文兜底\ngrep -n \"已切换到\" src/lib/accessibility-manager.ts\n# 应该返回空结果\n```\n\n### 边界情况测试\n- 测试页面刷新后语言是否保持\n- 测试快速切换语言时播报是否正确\n- 测试在无屏幕阅读器时是否不报错",
      "analysisResult": "## 全局分析结果\n\n### 任务目标\n修复项目中所有用户可见的硬编码问题,确保英文页面无中文、中文页面无英文(技术名称除外),实现完整的国际化支持。\n\n### 技术栈\n- Next.js 15 App Router\n- React 19\n- TypeScript 5.8\n- next-intl 4.3.4 国际化系统\n- 翻译文件: messages/en.json, messages/zh.json\n\n### 已完成\n✅ Tech Stack 数据国际化 (src/lib/tech-stack-data.ts)\n✅ Project Overview 语言单位国际化 (src/components/home/project-overview.tsx)\n\n### 待修复问题分类\n\n#### 高优先级 (用户可见)\n1. **主题切换器中英混排** - 中文页面显示 \"明亮模式 Light\"\n2. **语言切换高级信息英文硬编码** - 中文页面显示 \"Detection Info\"\n3. **无障碍播报默认语言** - 默认为中文,应跟随当前 locale\n\n#### 中优先级 (建议修复)\n4. **语言配置 region 字段** - 预防性修复,为未来 UI 展示做准备\n\n#### 低优先级 (可选)\n5. **CSS 颜色字面量** - 开发工具和邮件模板,不影响用户体验\n\n### 修复原则\n- 所有用户可见文案必须通过 next-intl 翻译系统\n- 使用 useTranslations() Hook 获取翻译\n- 翻译键统一管理在 messages/en.json 和 messages/zh.json\n- 保持代码简洁,避免重复\n- 每个任务独立可验证",
      "summary": "任务3完成: 无障碍播报语言跟随locale修复成功。accessibility-manager.ts默认语言从'zh'改为'en',兜底文案从中文改为英文,use-theme-toggle.ts添加useLocale和useEffect绑定locale到accessibilityManager.setLanguage(),实现语言自动跟随当前页面locale切换。质量检查: ESLint 0错误, TypeScript 0错误, Prettier格式化通过。",
      "completedAt": "2025-09-30T07:49:10.231Z"
    }
  ]
}